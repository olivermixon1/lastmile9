<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - Last Mile Trucking</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
    }
    .layout {
        display: flex;
        min-height: 100vh;
    }
    .sidebar {
        width: 220px;
        background: #111827;
        color: #e5e7eb;
        padding: 20px;
    }
    .sidebar h1 {
        font-size: 20px;
        margin-bottom: 24px;
    }
    .sidebar a {
        display: block;
        color: #9ca3af;
        text-decoration: none;
        padding: 8px 0;
        font-size: 14px;
    }
    .sidebar a.active,
    .sidebar a:hover {
        color: #ffffff;
    }
    .main {
        flex: 1;
        padding: 24px;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    .header h2 {
        margin: 0;
        font-size: 24px;
    }
    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .card {
        background: #ffffff;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card-label {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 8px;
    }
    .card-value {
        font-size: 22px;
        font-weight: 600;
    }
    .section {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
        overflow: hidden;
    }
    .section-header {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .section-header h3 {
        margin: 0;
        font-size: 16px;
    }
    .section-body {
        padding: 0;
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    thead {
        background: #f9fafb;
    }
    th, td {
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
    }
    th {
        font-weight: 500;
        color: #6b7280;
    }
    tr:hover td {
        background: #f3f4f6;
    }
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
    }
    .badge-available { background: #d1fae5; color: #065f46; }
    .badge-assigned { background: #dbeafe; color: #1d4ed8; }
    .badge-completed { background: #e5e7eb; color: #4b5563; }
    .btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        font-size: 12px;
        cursor: pointer;
    }
    .btn-primary {
        background: #2563eb;
        color: #ffffff;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success {
        background: #16a34a;
        color: #ffffff;
    }
    .btn-success:hover { background: #15803d; }
    .driver-select {
        width: 140px;
        font-size: 12px;
        padding: 4px;
    }
    @media (max-width: 768px) {
        .layout {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar nav {
            display: flex;
            gap: 12px;
        }
    }
</style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div>
            <h1>Last Mile Admin</h1>
            <nav>
                <a href="/admin" class="active">Dashboard</a>
                <a href="/shipper">Shipper Form</a>
                <a href="/docs" target="_blank">API Docs</a>
            </nav>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <h2>Control Center</h2>
            <span id="last-updated" style="font-size:12px;color:#6b7280;"></span>
        </div>

        <section class="cards">
            <div class="card">
                <div class="card-label">Total Jobs</div>
                <div class="card-value" id="stat-total">0</div>
            </div>
            <div class="card">
                <div class="card-label">Available</div>
                <div class="card-value" id="stat-available">0</div>
            </div>
            <div class="card">
                <div class="card-label">Assigned</div>
                <div class="card-value" id="stat-assigned">0</div>
            </div>
            <div class="card">
                <div class="card-label">Completed</div>
                <div class="card-value" id="stat-completed">0</div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h3>Jobs</h3>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>
            <div class="section-body">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Pickup</th>
                            <th>Dropoff</th>
                            <th>Load</th>
                            <th>Status</th>
                            <th>Driver</th>
                            <th>Assign</th>
                            <th>Complete</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-body">
                        <!-- rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h3>Drivers</h3>
            </div>
            <div class="section-body">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Current Location</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-body">
                        <!-- rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<script>
let driversCache = [];

// Load all data
async function refreshData() {
    try {
        const [jobsRes, driversRes] = await Promise.all([
            fetch("/jobs"),
            fetch("/drivers")
        ]);

        const jobs = await jobsRes.json();
        const drivers = await driversRes.json();
        driversCache = drivers;

        renderStats(jobs);
        renderJobs(jobs, drivers);
        renderDrivers(drivers);

        const now = new Date();
        document.getElementById("last-updated").innerText =
            "Last updated: " + now.toLocaleTimeString();
    } catch (err) {
        console.error("Error loading data:", err);
        alert("Failed to load dashboard data. Check console/logs.");
    }
}

function renderStats(jobs) {
    const total = jobs.length;
    const available = jobs.filter(j => j.status === "available").length;
    const assigned = jobs.filter(j => j.status === "assigned").length;
    const completed = jobs.filter(j => j.status === "completed").length;

    document.getElementById("stat-total").innerText = total;
    document.getElementById("stat-available").innerText = available;
    document.getElementById("stat-assigned").innerText = assigned;
    document.getElementById("stat-completed").innerText = completed;
}

function renderJobs(jobs, drivers) {
    const tbody = document.getElementById("jobs-body");
    tbody.innerHTML = "";

    jobs.forEach(job => {
        const tr = document.createElement("tr");

        const statusBadge = document.createElement("span");
        statusBadge.classList.add("badge");
        if (job.status === "available") statusBadge.classList.add("badge-available");
        else if (job.status === "assigned") statusBadge.classList.add("badge-assigned");
        else statusBadge.classList.add("badge-completed");
        statusBadge.innerText = job.status.charAt(0).toUpperCase() + job.status.slice(1);

        const driverName = job.driver_id
            ? (drivers.find(d => d.id === job.driver_id)?.name || "Driver " + job.driver_id)
            : "Unassigned";

        const driverSelectId = `driver-select-${job.id}`;

        tr.innerHTML = `
            <td>${job.id}</td>
            <td>${job.pickup_location}</td>
            <td>${job.dropoff_location}</td>
            <td>${job.load_description}</td>
            <td></td>
            <td>${driverName}</td>
            <td>
                <select id="${driverSelectId}" class="driver-select">
                    <option value="">Select driver</option>
                </select>
                <button class="btn btn-primary" onclick="assignDriver(${job.id})">Assign</button>
            </td>
            <td>
                <button class="btn btn-success" onclick="completeJob(${job.id})">Complete</button>
            </td>
        `;

        tr.children[4].appendChild(statusBadge);

        tbody.appendChild(tr);

        const selectEl = document.getElementById(driverSelectId);
        drivers.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = `${d.id} - ${d.name}`;
            selectEl.appendChild(opt);
        });
    });
}

function renderDrivers(drivers) {
    const tbody = document.getElementById("drivers-body");
    tbody.innerHTML = "";

    drivers.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.id}</td>
            <td>${d.name}</td>
            <td>${d.current_location}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function assignDriver(jobId) {
    const selectEl = document.getElementById(`driver-select-${jobId}`);
    const driverId = selectEl.value;
    if (!driverId) {
        alert("Select a driver first.");
        return;
    }

    try {
        const res = await fetch(`/assign/${jobId}/${driverId}`, {
            method: "POST"
        });
        if (!res.ok) throw new Error("Failed to assign driver");
        await refreshData();
    } catch (err) {
        console.error(err);
        alert("Error assigning driver.");
    }
}

async function completeJob(jobId) {
    if (!confirm(`Mark job #${jobId} as completed?`)) return;

    try {
        const res = await fetch(`/complete/${jobId}`, {
            method: "POST"
        });
        if (!res.ok) throw new Error("Failed to complete job");
        await refreshData();
    } catch (err) {
        console.error(err);
        alert("Error completing job.");
    }
}

refreshData();
setInterval(refreshData, 30000);
</script>

</body>
</html>
